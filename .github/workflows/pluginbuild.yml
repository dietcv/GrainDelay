name: Build Plugin

on:
  push:
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        os: [macos-14, macos-13, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Get SuperCollider source
      timeout-minutes: 8
      id: git_clone
      continue-on-error: true
      run: git clone --depth 1 https://github.com/supercollider/supercollider.git ${{ github.workspace }}/supercollider

    - name: Fallback SuperCollider download
      if: steps.git_clone.outcome == 'failure'
      timeout-minutes: 5
      shell: pwsh
      run: |
        Write-Host "Git clone failed, downloading zip..."
        Invoke-WebRequest -Uri "https://github.com/supercollider/supercollider/archive/refs/heads/main.zip" -OutFile "sc.zip"
        Expand-Archive -Path "sc.zip" -DestinationPath "."
        Move-Item "supercollider-main" "${{ github.workspace }}/supercollider"

    - name: Create build environment
      run: cmake -E make_directory ${{ github.workspace }}/build

    - name: Configure CMake (Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      working-directory: ${{ github.workspace }}/build
      run: cmake .. -DCMAKE_BUILD_TYPE='Release' -DSC_PATH=${{ github.workspace }}/supercollider

    - name: Configure CMake (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      working-directory: ${{ github.workspace }}\build
      run: cmake .. -DCMAKE_BUILD_TYPE='Release' -DSC_PATH="${{ github.workspace }}\supercollider"

    - name: Build plugin
      working-directory: ${{ github.workspace }}/build
      run: cmake --build . --config "Release" --target install

    - name: Package plugin (macOS-14)
      if: matrix.os == 'macos-14'
      shell: bash
      working-directory: ${{ github.workspace }}/build
      run: |
        # Create SuperCollider plugin structure
        mkdir -p GrainDelay-package/GrainDelay/Classes
        mkdir -p GrainDelay-package/GrainDelay/HelpSource
        
        # Copy files to locations
        find GrainDelay/ -name "*.scx" -exec cp {} GrainDelay-package/GrainDelay/ \; 2>/dev/null
        find GrainDelay/ -name "*.sc" -exec cp {} GrainDelay-package/GrainDelay/Classes/ \; 2>/dev/null
        find GrainDelay/ -name "*.schelp" -exec cp {} GrainDelay-package/GrainDelay/HelpSource/ \; 2>/dev/null
        
        # Show the structure
        echo "Plugin structure:"
        find GrainDelay-package/ -type f
        
        # Create zip from the plugin folder
        cd GrainDelay-package && zip -r ../GrainDelay-macOS-ARM.zip GrainDelay && cd ..

    - name: Package plugin (macOS-13)
      if: matrix.os == 'macos-13'
      shell: bash
      working-directory: ${{ github.workspace }}/build
      run: |
        # Create SuperCollider plugin structure
        mkdir -p GrainDelay-package/GrainDelay/Classes
        mkdir -p GrainDelay-package/GrainDelay/HelpSource
        
        # Copy files to locations
        find GrainDelay/ -name "*.scx" -exec cp {} GrainDelay-package/GrainDelay/ \; 2>/dev/null
        find GrainDelay/ -name "*.sc" -exec cp {} GrainDelay-package/GrainDelay/Classes/ \; 2>/dev/null
        find GrainDelay/ -name "*.schelp" -exec cp {} GrainDelay-package/GrainDelay/HelpSource/ \; 2>/dev/null
        
        # Show the structure
        echo "Plugin structure:"
        find GrainDelay-package/ -type f
        
        # Create zip from the plugin folder
        cd GrainDelay-package && zip -r ../GrainDelay-macOS-Intel.zip GrainDelay && cd ..

    - name: Package plugin (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      working-directory: ${{ github.workspace }}\build
      run: |
        # Create SuperCollider plugin structure
        New-Item -ItemType Directory -Force -Path "GrainDelay-package\GrainDelay\Classes"
        New-Item -ItemType Directory -Force -Path "GrainDelay-package\GrainDelay\HelpSource"
        
        # Copy files to locations
        Get-ChildItem "GrainDelay" -Recurse -Include "*.scx" | Copy-Item -Destination "GrainDelay-package\GrainDelay" -Force
        Get-ChildItem "GrainDelay" -Recurse -Include "*.sc" | Copy-Item -Destination "GrainDelay-package\GrainDelay\Classes" -Force
        Get-ChildItem "GrainDelay" -Recurse -Include "*.schelp" | Copy-Item -Destination "GrainDelay-package\GrainDelay\HelpSource" -Force
        
        # Show the structure
        Write-Host "Plugin structure:"
        Get-ChildItem "GrainDelay-package" -Recurse
        
        # Create zip from the plugin folder
        Compress-Archive -Path "GrainDelay-package\GrainDelay" -DestinationPath "GrainDelay-Windows.zip" -Force

    # Store as artifacts - works for both manual runs and tag pushes
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: GrainDelay-${{ matrix.os }}
        path: ${{ github.workspace }}/build/GrainDelay-*.zip